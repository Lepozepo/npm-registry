#!/bin/bash

set -e

COUCHAPP_VERSION=v2.4.0
COUCHAPP_GIT=https://github.com/npm/npm-registry-couchapp.git
COUCHAPP_LOCAL_PATH=/opt/couchapp

git clone "${COUCHAPP_GIT}" "${COUCHAPP_LOCAL_PATH}"

cd "${COUCHAPP_LOCAL_PATH}"

npm install

cp /app/setup/couchdb.ini /etc/couchdb/local.ini

cat > /etc/supervisor/conf.d/couchdb.conf <<EOF
[program:couchdb]
priority=20
directory=/tmp
command=/usr/bin/couchdb
user=root
autostart=false
autorestart=true
stdout_logfile=/var/log/supervisor/%(program_name)s.log
stderr_logfile=/var/log/supervisor/%(program_name)s.log
EOF
